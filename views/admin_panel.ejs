<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.css" rel="stylesheet">
    <title>پنل ادمین</title>

    <style>
        @font-face {
            font-family: 'vazir';
            src: url('/css/Vazir-Bold.ttf');
        }

        body {
            font-family: 'vazir';
            color: #fff;
        }

        .sidebar {
            background-color: rgb(74, 170, 138);
            height: 100vh;
            padding: 20px;
            position: sticky;
            top: 0;
        }

        .sidebar ul {
            list-style: none;
            justify-content: center;
        }

        .sidebar li {
            text-align: center;
            font-size: large;
            padding: 5px;
            transition: 0.5s;
            margin-top: 20px;
        }

        .sidebar li:hover {
            border-radius: 20px;
            background-color: aquamarine;
            color: black;
            transition: 0.5s;
            cursor: pointer;
        }

        .error_back {
            background-color: red !important;
        }

        .success_back {
            background-color: rgb(33, 161, 16) !important;
        }

        .warn_back {
            background-color: rgb(175, 106, 15) !important;
        }

        .info_back {
            background-color: rgb(100, 100, 100) !important;
        }
    </style>
</head>

<body>


    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 col-lg-2 sidebar">
                <ul>
                    <li> <i class="bi bi-speedometer"></i> داشبورد </li>
                    <% if(permissions.includes('VIEW_POSTS') || permissions.includes('ADMINISTRATOR')){ %>
                        <li onclick="selectSec('post_template')"><i class="bi bi-box"></i> پست ها </li>
                        <%}%>

                            <% if(permissions.includes('VIEW_POSTS') || permissions.includes('ADMINISTRATOR')){ %>
                                <li onclick="selectSec('Images_template')"><i class="bi bi-image"></i> عکس ها </li>
                                <%}%>


                                    <% if(permissions.includes('VIEW_CATEGORY') ||
                                        permissions.includes('ADMINISTRATOR')){ %>
                                        <li onclick="selectSec('category_template')"> <i class="bi bi-list"></i> دسته
                                            بندی ها </li>
                                        <%}%>

                                            <li> <i class="bi bi-people"></i> کاربران </li>

                                            <% if(permissions.includes('VIEW_ROLE') ||
                                                permissions.includes('ADMINISTRATOR')){ %>
                                                <li onclick="selectSec('roles_template')"> <i class="bi bi-people"></i>
                                                    نقش ها
                                                </li>
                                                <%}%>

                                                    <% if(permissions.includes('VIEW_LOGS') ||
                                                        permissions.includes('ADMINISTRATOR')){ %>
                                                        <li onclick="selectSec('log_template')"> <i
                                                                class="bi bi-file-earmark-post"></i> لاگ ها
                                                        </li>
                                                        <%}%>

                </ul>

                <ul>
                    <hr>
                    <li> <i class="bi bi-brightness-high"></i> دارک مود </li>
                    <a href="http://localhost:3000/user/logout">
                        <li class="text-danger bg-dark rounded-3"> <i class="bi bi-box-arrow-right"></i> خروج </li>
                    </a>
                </ul>
            </div>
            <div class="col-md-9 col-lg-10" id="MainContent">


            </div>

            <template id="log_template">
                <div class="container py-5">
                    <h2 class="text-dark mb-4">لاگ‌ها</h2>

                    <!-- نوبار فیلتر و جستجو -->
                    <nav class="navbar bg-light rounded shadow-sm px-3 mb-4">
                        <div class="container-fluid flex-wrap justify-content-between">

                            <div id="all_log_count" class="text-dark">تعداد کلی : </div>
                            <!-- فیلتر و رفرش -->
                            <div class="d-flex gap-4 align-items-center">
                                <select class="form-select" onclick="filter_log(this.value)">
                                    <option value="all">همه</option>
                                    <option value="success">موفق</option>
                                    <option value="info">اطلاعات</option>
                                    <option value="warn">هشدار</option>
                                    <option value="error">خطا</option>
                                </select>
                                <button class="btn btn-outline-primary" id="log_refresh_btn" onclick=" get_logs()">
                                    <i class="bi bi-arrow-clockwise"></i> رفرش
                                </button>
                                <button class="btn btn-outline-primary">
                                    <a class="nav-link" href="http://localhost:3000/log/download/all">خروجی JSON</a>
                                </button>
                            </div>
                        </div>
                    </nav>



                    <!-- ردیف نمایش لاگ‌ها -->
                    <div class="row" id="log_results_row">

                    </div>
                </div>
            </template>

            <template id="category_template">
                <div class="container p-5 text-dark">
                    <form id="add_cat" class="d-flex">
                        <input type="text" name="" id="input_cat_name" class="form-control w-25 me-2">
                        <button type="submit" class="btn btn-success">ذخیره</button>
                    </form>
                </div>
                <div class="container p-5">
                    <table class="table" id="table">
                        <tr>
                            <th class="col">ID</th>
                            <th class="col">نام دسته بندی</th>
                            <th class="col">تاریخ ساخت</th>
                            <th><button onclick="get_category()" class="p-1"><i
                                        class="bi bi-arrow-clockwise"></i></button></th>
                        </tr>
                    </table>
                </div>



                <div class="container p-5 text-dark">
                    <form id="add_sub_cat" class="d-flex">
                        <input type="text" name="" id="input_sub_cat_name" class="form-control w-25 me-2">
                        <select id="select_sub_category" class="me-2">

                        </select>
                        <button type="submit" class="btn btn-success">ذخیره</button>
                    </form>
                </div>
                <div class="container p-5">
                    <table class="table" id="table2">
                        <tr>
                            <th class="col">ID</th>
                            <th class="col">نام زیر دسته بندی</th>
                            <th class="col">تاریخ ساخت</th>
                            <th class="col"> ایدی دسته بندی اصلی</th>
                            <th><button onclick="get_sub_category()" class="p-1"><i
                                        class="bi bi-arrow-clockwise"></i></button></th>
                        </tr>
                    </table>
                </div>
            </template>

            <template id="post_template">
                <div class="container p-5 d-flex">
                    <div class="row p-2">
                        <div class="col-2">
                            <!-- Button trigger modal -->
                            <button type="button" class="btn btn-outline-success" data-bs-toggle="modal"
                                data-bs-target="#exampleModal">
                                <i class="bi bi-plus-square"></i> پست جدید
                            </button>

                            <!-- Modal -->
                            <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                                aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h1 class="modal-title fs-5" id="exampleModalLabel"></h1>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <form class="p-4 border rounded"
                                                style="max-width: 600px; margin: auto;" id="form_create_post">
                                                <div class="mb-3">
                                                    <label for="title" class="form-label">عنوان</label>
                                                    <input type="text" class="form-control" id="title" name="title"
                                                        placeholder="عنوان را وارد کنید" required>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="description" class="form-label">توضیحات</label>
                                                    <textarea class="form-control" id="description" name="description"
                                                        rows="4" placeholder="متن توضیحات"></textarea>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="more_description" class="form-label">توضیحات
                                                        بیشتر</label>
                                                    <textarea class="form-control" id="more_description"
                                                        name="more_description" rows="4"
                                                        placeholder="توضیحات بیشتر"></textarea>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="category_id" class="form-label">شناسه دسته‌بندی</label>
                                                    <input type="number" class="form-control" id="category_id"
                                                        name="category_id" placeholder="شماره دسته‌بندی" required>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="sub_category_id" class="form-label">شناسه زیر
                                                        دسته</label>
                                                    <input type="number" class="form-control" id="sub_category_id"
                                                        name="sub_category_id" placeholder="شماره زیر دسته" required>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="img_path" class="form-label">نام تصویر (بدون
                                                        فایل)</label>
                                                    <input type="text" class="form-control" id="img_path"
                                                        name="img_path" placeholder="نام تصویر" required>
                                                </div>

                                                <button type="submit" class="btn btn-primary w-100">ارسال</button>
                                            </form>
                                        </div>
                                        <div class="modal-footer">
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </template>

            <template id="Images_template">
                <div class="container d-flex p-5 text-dark">
                    <h5 class="me-5">عکس ها</h5>
                    <form id="Update_img_form">
                        <input type="file" name="myfile" id="file_img" required>

                        <button type="submit">آپلود</button>
                    </form>
                </div>
                <div id="images" class="row">
                </div>
            </template>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let logs = []
        let categorys = []
        let sub_category = []
        let all_log_count = 0
        let images = []

        function create_post(){
document.getElementById('form_create_post').addEventListener('submit', function(event) {
    event.preventDefault(); // جلوگیری از ارسال پیش‌فرض فرم

    // جمع‌آوری داده‌های فرم
    const formData = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        more_description: document.getElementById('more_description').value,
        category_id: parseInt(document.getElementById('category_id').value),
        sub_category_id: parseInt(document.getElementById('sub_category_id').value),
        img_path: document.getElementById('img_path').value
    };

    // ارسال داده‌ها با fetch به API
    fetch('http://localhost:3000/post/create', { // آدرس API خود را جایگزین کنید
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('خطا در ارسال دیتا');
        }
        return response.json();
    })
    .then(data => {
        // عملیات بعد از موفقیت
        alert('پوشش با موفقیت ارسال شد!');
        console.log(data);
        // در صورت نیاز، فرم را ریست کنید
        document.getElementById('form_create_post').reset();
    })
    .catch(error => {
        alert('خطا: ' + error.message);
        console.error('Error:', error);
    });
});
        }

        
        async function bindForm() {
            document.getElementById('Update_img_form').addEventListener('submit', async (event) => {
                const img = document.getElementById('file_img')
                const formData = new FormData();
                formData.append('myfile', img.files[0]);

                event.preventDefault()
                const result = await fetch('http://localhost:3000/upload/images', {
                    method: "POST",
                    body: formData
                })

                const data = await result.json()
                console.log(data);


            })

            const result = await fetch('http://localhost:3000/get/images', {
                method: "GET",
            })

            const images_div = document.getElementById('images')

            images = await result.json()
            images.forEach(img => {
                const div = document.createElement('div')
                div.classList.add('col-3')

                div.innerHTML = `
                         
                     <img src="http://localhost:3000/images/${img.name}">

                      <h3 class="text-dark">${img.name}</h3>
                      
                <button onclick="delete_img('${img.name}')">حذف</button>

                     `

                images_div.appendChild(div)
            })

        }



        async function delete_img(name) {
            const result = await fetch(`http://localhost:3000/image/delete/${name}`, {
                method: "DELETE"
            })

            const data = await result.json()
            alert(data)
            bindForm()
        }

        function add_cat() {
            document.getElementById('add_cat').addEventListener('submit', async (event) => {
                event.preventDefault()
                const name = document.getElementById('input_cat_name').value

                const result = await fetch('http://localhost:3000/post/category/add', {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name })

                })
                const data = await result.json()
                alert(data)
                get_category()
            })
        }



        function add_sub_cat() {
            document.getElementById('add_sub_cat').addEventListener('submit', async (event) => {
                event.preventDefault()
                const name = document.getElementById('input_sub_cat_name').value
                const category_id = document.getElementById('select_sub_category').value

                const result = await fetch('http://localhost:3000/post/sub/category/add', {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, category_id })

                })
                const data = await result.json()
                alert(data)
                get_category()
            })
        }




        async function get_category() {
            categorys = []
            const result = await fetch('http://localhost:3000/post/get/categorys', {
                method: "GET",
            })
            categorys = await result.json()

            const table = document.getElementById('table')
            const select_sub_category = document.getElementById('select_sub_category')
            table.innerHTML = `  <tr>
                            <th class="col">ID</th>
                            <th class="col">نام دسته بندی</th>
                            <th class="col">تاریخ ساخت</th>
                            <th><button onclick="get_category()" class="p-1"><i class="bi bi-arrow-clockwise"></i></button></th>
                        </tr>`
            categorys.forEach(category => {
                const tr = document.createElement('tr')
                tr.classList.add('text-dark')

                tr.innerHTML = `

                 <th scope="row">${category.id}</th>
      <td>${category.name}</td>
      <td>${category.create_time}</td>

      `
                table.appendChild(tr)


                const option = document.createElement('option')
                option.value = category.id
                option.innerText = category.name

                select_sub_category.appendChild(option)

            })
        }


        async function get_sub_category() {
            sub_category = []
            const result = await fetch('http://localhost:3000/post/get/sub/categorys', {
                method: "GET",
            })
            sub_category = await result.json()

            const table = document.getElementById('table2')
            table.innerHTML = `  <tr>
                            <th class="col">ID</th>
                            <th class="col">نام زیر دسته بندی</th>
                            <th class="col">تاریخ ساخت</th>
                            <th class="col"> ایدی دسته بندی اصلی</th>
                            <th><button onclick="get_sub_category()" class="p-1"><i
                                        class="bi bi-arrow-clockwise"></i></button></th>
                        </tr>`
            sub_category.forEach(category => {
                const tr = document.createElement('tr')
                tr.classList.add('text-dark')

                tr.innerHTML = `

                 <th scope="row">${category.id}</th>
      <td>${category.name}</td>
      <td>${category.create_time}</td>
      <td>${category.category_id}</td>


      `
                table.appendChild(tr)
            })
        }
        function selectSec(sectionid) {
            const template = document.getElementById(sectionid);
            document.getElementById('MainContent').innerHTML = template.innerHTML;

            if (sectionid === "category_template") {
                add_cat()
                add_sub_cat()
            }

            if (sectionid === "Images_template") {
                bindForm()
            }

            if(sectionid === "post_template"){
                create_post()
            }

        }
        async function get_logs() {
            logs = []
            all_log_count = document.getElementById('all_log_count')
            const result = await fetch('http://localhost:3000/log/get', {
                method: "GET"
            })
            const log_results_row = document.getElementById('log_results_row')
            log_results_row.innerHTML = '' // پاک‌سازی لاگ‌های قبلی

            logs = await result.json()
            logs.forEach(log => {
                const div = document.createElement('div')
                div.classList.add('col-4', 'p-2', 'm-1', 'rounded-3', 'log_card', `${log.level}_back`);

                div.innerHTML = `
            <h6>موضوع : ${log.title} </h6>
            <p>متن : ${log.message} </p>
            <h6>ایپی : ${log.ip}</h6>
            <h6>تاریخ : ${log.time}</h6>
            <button onclick="delete_log(${log.id})"> <i class="bi bi-trash text-danger"></i> </button>
        `
                log_results_row.appendChild(div)
            });

            all_log_count.innerHTML = `تعداد کلی لاگ ها : ${logs.length}`
        }
        function filter_log(type) {
            const allLogs = document.querySelectorAll('.log_card');
            allLogs.forEach(log => {
                if (type === 'all') {
                    log.style.display = 'block';
                } else {
                    if (log.classList.contains(`${type}_back`)) {
                        log.style.display = 'block';
                    } else {
                        log.style.display = 'none';
                    }
                }
            });
        }

        async function delete_log(id) {
            const result = await fetch(`http://localhost:3000/log/delete/${id}`, {
                method: "POST"
            })

            const data = await result.json()
            alert(data)
        }

    </script>
</body>

</html>